<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Child Genetic Profiling - Test App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 650px;
            width: 90%;
            text-align: center;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: 300;
        }

        h2 {
            color: #555;
            margin-bottom: 20px;
            font-size: 1.8em;
            font-weight: 400;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
        }

        input[type="text"], input[type="email"], input[type="password"], input[type="date"], select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
            min-width: 120px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-dr-bloom {
            background: linear-gradient(135deg, #ff6b6b 0%, #f06595 100%);
        }

        .btn-dr-bloom:hover {
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .btn-immunity {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        }

        .btn-immunity:hover {
            box-shadow: 0 5px 15px rgba(255, 154, 158, 0.4);
        }

        .btn-growth {
            background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
        }

        .btn-growth:hover {
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        /* Immunity Dashboard Styles */
        .trait-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            border-left: 4px solid #ff9a9e;
        }

        .suggestion-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #28a745;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .suggestion-item.avoid {
            border-left-color: #dc3545;
        }

        .suggestion-icon {
            font-size: 20px;
            margin-top: 2px;
        }

        .suggestion-content {
            flex: 1;
        }

        .suggestion-text {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .suggestion-rationale {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }

        .medical-log-item {
            background: #e8f4fd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }

        .log-date {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .log-summary {
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .log-details {
            font-size: 14px;
            color: #555;
        }

        .recommendation-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }

        .recommendation-item h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .timestamp {
            color: #999;
            font-size: 0.9em;
            font-style: italic;
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #a8a8a8 0%, #8c8c8c 100%);
        }

        .btn-secondary:hover {
            box-shadow: 0 10px 20px rgba(168, 168, 168, 0.3);
        }

        .child-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
            text-align: left;
        }

        .child-card .button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 15px;
        }

        .child-card .button-grid button {
            margin: 0;
            font-size: 14px;
            padding: 8px 12px;
        }

        .child-card h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .child-card p {
            color: #666;
            margin: 5px 0;
        }

        .question-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            text-align: left;
        }

        .question-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .option {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e1e5e9;
            border-radius: 3px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        .recommendation {
            background: #e8f5e8;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #28a745;
            text-align: left;
        }

        .recommendation h4 {
            color: #155724;
            margin-bottom: 5px;
        }

        .recommendation p {
            color: #155724;
            margin: 0;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .file-upload {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            background: #f0f4ff;
        }

        .file-upload input[type="file"] {
            display: none;
        }

        /* Chat Interface Styles */
        .chat-message {
            margin-bottom: 15px;
            max-width: 80%;
        }

        .chat-message.user {
            margin-left: auto;
            background: #667eea;
            color: white;
            padding: 12px 16px;
            border-radius: 18px 18px 4px 18px;
            text-align: right;
        }

        .chat-message.dr-bloom {
            margin-right: auto;
            background: white;
            border: 2px solid #e1e5e9;
            padding: 12px 16px;
            border-radius: 18px 18px 18px 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chat-message.dr-bloom .sender {
            font-weight: bold;
            color: #4CAF50;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .chat-message .timestamp {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .chat-message .image-attachment {
            margin-top: 8px;
            font-size: 12px;
            color: #666;
            font-style: italic;
        }

        .typing-indicator {
            background: white;
            border: 2px solid #e1e5e9;
            padding: 12px 16px;
            border-radius: 18px 18px 18px 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            max-width: 80%;
        }

        .typing-dots {
            display: inline-block;
        }

        .typing-dots span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #4CAF50;
            margin: 0 2px;
            animation: typing 1.4s infinite ease-in-out both;
        }

        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        #chatContainer::-webkit-scrollbar {
            width: 6px;
        }

        #chatContainer::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        #chatContainer::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        #chatContainer::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div class="screen active" id="loginScreen">
            <h1>Bloomie🌸</h1>
            <h2>Welcome Back</h2>
            <div class="form-group">
                <label for="loginEmail">Email</label>
                <input type="email" id="loginEmail" placeholder="Enter your email">
            </div>
            <div class="form-group">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" placeholder="Enter your password">
            </div>
            <button class="btn" onclick="login()">Login</button>
            <button class="btn btn-secondary" onclick="showRegister()">Create Account</button>
            <div id="loginError"></div>
        </div>

        <!-- Register Screen -->
        <div class="screen" id="registerScreen">
            <h1>Bloomie🌸</h1>
            <h2>Create Account</h2>
            <div class="form-group">
                <label for="registerName">Full Name</label>
                <input type="text" id="registerName" placeholder="Enter your full name">
            </div>
            <div class="form-group">
                <label for="registerEmail">Email</label>
                <input type="email" id="registerEmail" placeholder="Enter your email">
            </div>
            <div class="form-group">
                <label for="registerPassword">Password</label>
                <input type="password" id="registerPassword" placeholder="Create a password">
            </div>
            <button class="btn" onclick="register()">Create Account</button>
            <button class="btn btn-secondary" onclick="showLogin()">Back to Login</button>
            <div id="registerError"></div>
        </div>

        <!-- Dashboard Screen -->
        <div class="screen" id="dashboardScreen">
            <h1>👶 Your Children</h1>
            
            <!-- Latest Recommendations Widget -->
            <div id="latestRecommendationsWidget" style="background: #f0f7ff; border: 2px solid #667eea; border-radius: 12px; padding: 20px; margin-bottom: 20px; display: none;">
                <h2 style="color: #667eea; margin: 0 0 15px 0; font-size: 1.3em;">📌 Quick Overview - Latest Recommendations</h2>
                <div id="latestRecommendationsContent">
                    <p style="color: #666;">Loading recommendations...</p>
                </div>
            </div>
            
            <div id="childrenList"></div>
            <button class="btn" onclick="showAddChild()">Add New Child</button>
            <button class="btn btn-secondary" onclick="logout()">Logout</button>
        </div>

        <!-- Add Child Screen -->
        <div class="screen" id="addChildScreen">
            <h1>➕ Add New Child</h1>
            <div class="form-group">
                <label for="childName">Child's Name</label>
                <input type="text" id="childName" placeholder="Enter child's name">
            </div>
            <div class="form-group">
                <label for="geneticReport">Genetic Report (JSON or PDF)</label>
                <div class="file-upload" onclick="document.getElementById('geneticFile').click()">
                    <input type="file" id="geneticFile" accept=".json,.pdf" onchange="handleFileSelect(event)">
                    <p id="fileStatus">Click to upload genetic report (JSON or PDF)</p>
                </div>
            </div>
            <button class="btn" onclick="uploadGeneticReport()" id="uploadBtn" disabled>Upload Report</button>
            <button class="btn btn-secondary" onclick="showDashboard()">Back</button>
            <div id="uploadError"></div>
        </div>

        <!-- Questions Screen -->
        <div class="screen" id="questionsScreen">
            <h1>📝 Weekly Check-in</h1>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="questionContainer"></div>
            <div id="questionError"></div>
            <button class="btn btn-secondary" onclick="showDashboard()" style="margin-top: 20px;">Back to Dashboard</button>
        </div>

        <!-- Results Screen -->
        <div class="screen" id="resultsScreen">
            <h1>✅ Check-in Complete!</h1>
            <div id="recommendationsContainer"></div>
            <button class="btn" onclick="showDashboard()">Back to Dashboard</button>
        </div>

        <!-- Recommendations History Screen -->
        <div class="screen" id="historyScreen">
            <h1>📚 Recommendations History</h1>
            <div id="historyContainer"></div>
            <button class="btn" onclick="showDashboard()">Back to Dashboard</button>
        </div>
        
        <!-- Latest Recommendations Detail Screen -->
        <div class="screen" id="latestRecommendationsScreen">
            <h1>📌 Latest Recommendations</h1>
            <div id="latestRecommendationsContainer"></div>
            <button class="btn" onclick="showDashboard()">Back to Dashboard</button>
        </div>

        <!-- Traits Display Screen -->
        <div class="screen" id="traitsScreen">
            <h1>Genetic Traits Report</h1>
            <div id="traitsContainer"></div>
            <button class="btn" onclick="showDashboard()">Back to Dashboard</button>
        </div>

        <!-- Dr. Bloom Chat Screen -->
        <div class="screen" id="drBloomScreen">
            <h1 style="color: #4CAF50;">💬 Dr. Bloom Consultation</h1>
            
            <!-- Chat Interface -->
            <div id="drBloomChat">
                <div id="chatContainer" style="background: #f8f9fa; border: 2px solid #e1e5e9; border-radius: 8px; height: 400px; overflow-y: auto; padding: 15px; margin-bottom: 15px;">
                    <div id="chatMessages"></div>
                </div>
                
                <div class="form-group">
                    <div style="display: flex; gap: 10px;">
                        <textarea id="chatInput" placeholder="Type your message to Dr. Bloom..." rows="2" style="flex: 1; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 16px; resize: vertical;"></textarea>
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <button class="btn btn-dr-bloom" onclick="sendChatMessage()" id="sendBtn" style="height: fit-content;">Send</button>
                            <input type="file" id="chatImageFile" accept=".jpg,.jpeg,.png,.pdf" onchange="handleChatImageSelect(event)" style="display: none;">
                            <button class="btn btn-secondary" onclick="document.getElementById('chatImageFile').click()" style="height: fit-content; font-size: 12px;">📷</button>
                        </div>
                    </div>
                    <div id="chatImagePreview" style="margin-top: 10px; font-size: 14px; color: #666;"></div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn btn-success" onclick="completeDrBloomSession()" id="completeBtn">Complete Consultation</button>
                    <button class="btn btn-secondary" onclick="showDashboard()">Back to Dashboard</button>
                </div>
                <div id="drBloomChatError"></div>
            </div>
        </div>

        <!-- Immunity Dashboard Screen -->
        <div class="screen" id="immunityScreen">
            <h1 style="color: #FF6B6B;">🛡️ Immunity & Resilience Dashboard</h1>
            <button class="btn btn-secondary" onclick="showDashboard()" style="margin-bottom: 20px;">← Back to Dashboard</button>
            
            <!-- Main Content Container -->
            <div id="immunityContent"></div>
            
            <div id="immunityError"></div>
        </div>

        <!-- Growth Milestones Screen -->
        <div class="screen" id="growthMilestonesScreen">
            <h1 style="color: #4CAF50;">📈 Growth & Development Roadmap</h1>
            <button class="btn btn-secondary" onclick="showDashboard()" style="margin-bottom: 20px;">← Back to Dashboard</button>
            
            <!-- Simple roadmap display -->
            
            <!-- Dynamic Content -->
            <div id="growthContent"></div>
            
            <div id="growthError"></div>
        </div>
    </div>

    <script>
        // Global variables
        let authToken = localStorage.getItem('authToken');
        let currentQuestions = [];
        let currentAnswers = [];
        let currentQuestionIndex = 0;
        let currentChildId = null;
        let selectedFile = null;

        // API base URL - change this to your FastAPI server URL
        // const API_BASE = 'http://localhost:8000'; // Local development
        const API_BASE = 'https://child-profiling-api-271271835247.us-central1.run.app'; // Production Cloud Run

        // Utility functions
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function showError(elementId, message) {
            const errorDiv = document.getElementById(elementId);
            errorDiv.innerHTML = `<div class="error">${message}</div>`;
            setTimeout(() => {
                errorDiv.innerHTML = '';
            }, 5000);
        }

        function showSuccess(elementId, message) {
            const successDiv = document.getElementById(elementId);
            successDiv.innerHTML = `<div class="success">${message}</div>`;
            setTimeout(() => {
                successDiv.innerHTML = '';
            }, 5000);
        }

        async function apiCall(endpoint, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                'X-API-Key': 'secure-api-key-2025', // Replace with your actual API key
                ...(authToken && { 'Authorization': `Bearer ${authToken}` }),
                ...options.headers
            };

            const fullUrl = `${API_BASE}${endpoint}`;
            console.log('🌐 API CALL:', {
                url: fullUrl,
                method: options.method || 'GET',
                headers: headers,
                body: options.body
            });

            const response = await fetch(fullUrl, {
                ...options,
                headers
            });

            console.log('📡 API RESPONSE:', {
                status: response.status,
                statusText: response.statusText,
                headers: Object.fromEntries(response.headers.entries())
            });

            if (!response.ok) {
                const error = await response.json();
                console.log('❌ API ERROR RESPONSE:', error);
                throw new Error(error.detail || 'API call failed');
            }

            const result = await response.json();
            console.log('✅ API SUCCESS RESPONSE:', result);
            return result;
        }

        // Authentication functions
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            console.log('🔑 LOGIN ATTEMPT:', { email, password: password ? '[HIDDEN]' : 'EMPTY' });

            if (!email || !password) {
                console.log('❌ LOGIN VALIDATION: Missing fields');
                showError('loginError', 'Please fill in all fields');
                return;
            }

            try {
                console.log('📡 SENDING LOGIN REQUEST to:', `${API_BASE}/auth/login`);
                const response = await apiCall('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });

                console.log('✅ LOGIN RESPONSE:', response);
                authToken = response.access_token;
                localStorage.setItem('authToken', authToken);
                loadDashboard();
            } catch (error) {
                console.log('❌ LOGIN ERROR:', error);
                showError('loginError', error.message);
            }
        }

        async function register() {
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;

            if (!name || !email || !password) {
                showError('registerError', 'Please fill in all fields');
                return;
            }

            try {
                const response = await apiCall('/auth/register', {
                    method: 'POST',
                    body: JSON.stringify({ name, email, password })
                });

                authToken = response.access_token;
                localStorage.setItem('authToken', authToken);
                loadDashboard();
            } catch (error) {
                showError('registerError', error.message);
            }
        }

        function logout() {
            authToken = null;
            localStorage.removeItem('authToken');
            showLogin();
        }

        // Screen navigation functions
        function showLogin() {
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            showScreen('loginScreen');
        }

        function showRegister() {
            document.getElementById('registerName').value = '';
            document.getElementById('registerEmail').value = '';
            document.getElementById('registerPassword').value = '';
            showScreen('registerScreen');
        }

        function showDashboard() {
            loadDashboard();
        }

        function showAddChild() {
            document.getElementById('childName').value = '';
            document.getElementById('fileStatus').textContent = 'Click to upload genetic report JSON file';
            document.getElementById('uploadBtn').disabled = true;
            selectedFile = null;
            showScreen('addChildScreen');
        }

        // Dashboard functions
        async function loadDashboard() {
            try {
                const children = await apiCall('/children');
                displayChildren(children);
                
                // Load latest recommendations for the first child (if any)
                if (children.length > 0) {
                    loadLatestRecommendations(children[0].id);
                }
                
                showScreen('dashboardScreen');
            } catch (error) {
                showError('loginError', 'Failed to load dashboard');
                logout();
            }
        }

        function displayChildren(children) {
            const container = document.getElementById('childrenList');
            
            if (children.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">No children added yet. Add your first child to get started!</p>';
                // Hide recommendations widget if no children
                document.getElementById('latestRecommendationsWidget').style.display = 'none';
                return;
            }

            container.innerHTML = children.map(child => `
                <div class="child-card">
                    <h3>${child.name || `Child ${child.id}`}</h3>
                    <p><strong>Gender:</strong> ${child.gender}</p>
                    <p><strong>Birthday:</strong> ${child.birthday}</p>
                    <div class="button-grid">
                        <button class="btn" onclick="startCheckIn('${child.id}')">Weekly Check-in</button>
                        <button class="btn btn-secondary" onclick="viewRecommendations('${child.id}')">View History</button>
                        <button class="btn btn-secondary" onclick="viewTraits('${child.id}')">View Traits</button>
                        <button class="btn btn-immunity" onclick="viewImmunityDashboard('${child.id}')">Immunity & Resilience</button>
                        <button class="btn btn-growth" onclick="viewGrowthMilestones('${child.id}')">Growth & Development</button>
                        <button class="btn btn-dr-bloom" onclick="openDrBloomConsultation('${child.id}')">Consult Dr. Bloom</button>
                    </div>
                </div>
            `).join('');
        }
        
        async function loadLatestRecommendations(childId) {
            try {
                const data = await apiCall(`/children/${childId}/latest-recommendations`);
                displayLatestRecommendations(data);
            } catch (error) {
                console.error('Failed to load latest recommendations:', error);
                document.getElementById('latestRecommendationsWidget').style.display = 'none';
            }
        }
        
        function displayLatestRecommendations(data) {
            const widget = document.getElementById('latestRecommendationsWidget');
            const content = document.getElementById('latestRecommendationsContent');
            
            if (!data.recommendations || data.recommendations.length === 0) {
                content.innerHTML = `
                    <p style="color: #666; margin: 0;">No recommendations yet for <strong>${data.child_name}</strong>. Complete a weekly check-in to get started!</p>
                `;
                widget.style.display = 'block';
                return;
            }
            
            const lastCheckInDate = data.last_check_in_date ? new Date(data.last_check_in_date).toLocaleDateString() : 'N/A';
            
            content.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <p style="margin: 0;"><strong>${data.child_name}</strong> - Last check-in: ${lastCheckInDate}</p>
                </div>
                
                <div style="display: grid; gap: 8px;">
                    ${data.recommendations.map(rec => `
                        <div style="background: white; border: 1px solid #e1e5e9; border-radius: 6px; padding: 10px; display: flex; justify-content: space-between; align-items: center;">
                            <strong style="color: #667eea; font-size: 0.95em;">${rec.trait_name}</strong>
                            <span style="color: #333; font-size: 0.9em; text-align: right;">${rec.action}</span>
                        </div>
                    `).join('')}
                </div>
                
                <div style="margin-top: 15px; text-align: center;">
                    <button class="btn btn-secondary" onclick="viewLatestRecommendations('${data.child_id}')" style="font-size: 0.9em;">View Details</button>
                </div>
            `;
            
            widget.style.display = 'block';
        }

        // File upload functions
        function handleFileSelect(event) {
            selectedFile = event.target.files[0];
            if (selectedFile) {
                document.getElementById('fileStatus').textContent = `Selected: ${selectedFile.name}`;
                document.getElementById('uploadBtn').disabled = false;
            }
        }

        async function uploadGeneticReport() {
            const childName = document.getElementById('childName').value;
            
            if (!childName || !selectedFile) {
                showError('uploadError', 'Please provide child name and select a file');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('file', selectedFile);
                formData.append('child_name', childName);

                const response = await fetch(`${API_BASE}/children/upload-genetic-report`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'X-API-Key': 'secure-api-key-2025' // Replace with your actual API key
                    },
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Upload failed');
                }

                const result = await response.json();
                showSuccess('uploadError', 'Genetic report uploaded successfully!');
                
                // Display traits if available
                if (result.traits && result.traits.length > 0) {
                    setTimeout(() => {
                        displayTraits(result.traits, result.child_id);
                    }, 1000);
                } else {
                    setTimeout(() => {
                        loadDashboard();
                    }, 2000);
                }
            } catch (error) {
                showError('uploadError', error.message);
            }
        }

        // Check-in functions
        async function startCheckIn(childId) {
            currentChildId = childId;
            currentQuestionIndex = 0;
            currentAnswers = [];

            try {
                const response = await apiCall(`/children/${childId}/check-in/questions`);
                currentQuestions = response.questions;

                if (currentQuestions.length === 0) {
                    showError('uploadError', 'No questions available for check-in');
                    return;
                }

                showScreen('questionsScreen');
                displayQuestion();
            } catch (error) {
                showError('uploadError', `Failed to load questions: ${error.message}`);
            }
        }

        function displayQuestion() {
            const container = document.getElementById('questionContainer');
            const question = currentQuestions[currentQuestionIndex];
            
            // Update progress bar
            const progress = ((currentQuestionIndex + 1) / currentQuestions.length) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;

            container.innerHTML = `
                <div class="question-card">
                    <h3>Question ${currentQuestionIndex + 1} of ${currentQuestions.length}</h3>
                    <h3>${question.question}</h3>
                    <div id="optionsContainer">
                        ${question.options.map((option, index) => `
                            <div class="option" onclick="selectOption(${index})" data-option="${index}">
                                ${option}
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top: 20px;">
                        <button class="btn" onclick="nextQuestion()" id="nextBtn" disabled>
                            ${currentQuestionIndex === currentQuestions.length - 1 ? 'Submit' : 'Next'}
                        </button>
                        ${currentQuestionIndex > 0 ? '<button class="btn btn-secondary" onclick="prevQuestion()">Previous</button>' : ''}
                    </div>
                </div>
            `;
            
            // Restore previously selected answer if it exists
            if (currentAnswers[currentQuestionIndex]) {
                const selectedAnswer = currentAnswers[currentQuestionIndex].answer;
                const selectedIndex = question.options.findIndex(opt => opt === selectedAnswer);
                if (selectedIndex !== -1) {
                    document.querySelector(`[data-option="${selectedIndex}"]`).classList.add('selected');
                    document.getElementById('nextBtn').disabled = false;
                }
            }
        }

        function selectOption(optionIndex) {
            // Remove previous selection
            document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
            
            // Add selection to clicked option
            document.querySelector(`[data-option="${optionIndex}"]`).classList.add('selected');
            
            // Enable next button
            document.getElementById('nextBtn').disabled = false;
            
            // Store answer
            const question = currentQuestions[currentQuestionIndex];
            currentAnswers[currentQuestionIndex] = {
                question: question.question,
                answer: question.options[optionIndex]
            };
        }

        function nextQuestion() {
            if (currentQuestionIndex < currentQuestions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            } else {
                submitCheckIn();
            }
        }

        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        async function submitCheckIn() {
            try {
                const response = await apiCall(`/children/${currentChildId}/check-in/submit`, {
                    method: 'POST',
                    body: JSON.stringify({ answers: currentAnswers })
                });

                displayResults(response);
                showScreen('resultsScreen');
            } catch (error) {
                showError('questionError', `Failed to submit check-in: ${error.message}`);
            }
        }

        function displayResults(results) {
            const container = document.getElementById('recommendationsContainer');
            
            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h3>Summary</h3>
                    <p>${results.summary}</p>
                </div>
                <div>
                    <h3>Recommendations</h3>
                    ${results.recommendations.map(rec => `
                        <div class="recommendation">
                            <h4>${rec.trait}</h4>
                            <p><strong>Goal:</strong> ${rec.goal}</p>
                            <p><strong>Activity:</strong> ${rec.activity}</p>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // View Recommendations History
        async function viewRecommendations(childId) {
            try {
                const history = await apiCall(`/children/${childId}/recommendations-history`);
                displayRecommendationsHistory(history);
                showScreen('historyScreen');
            } catch (error) {
                showError('uploadError', `Failed to load recommendations history: ${error.message}`);
            }
        }
        
        async function viewLatestRecommendations(childId) {
            try {
                const data = await apiCall(`/children/${childId}/latest-recommendations-detail`);
                displayLatestRecommendationsDetail(data);
                showScreen('latestRecommendationsScreen');
            } catch (error) {
                document.getElementById('latestRecommendationsContainer').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h3 style="color: #f44336;">Failed to load latest recommendations</h3>
                        <p style="color: #666;">${error.message}</p>
                    </div>
                `;
                showScreen('latestRecommendationsScreen');
            }
        }
        
        function displayLatestRecommendationsDetail(data) {
            const container = document.getElementById('latestRecommendationsContainer');
            
            if (!data.recommendations || data.recommendations.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h3>No Recommendations Available</h3>
                        <p style="color: #666;">Complete a weekly check-in to get personalized recommendations for ${data.child_name}.</p>
                    </div>
                `;
                return;
            }
            
            const lastCheckInDate = data.last_check_in_date ? new Date(data.last_check_in_date).toLocaleDateString() : 'N/A';
            const entryTypeLabel = data.entry_type === 'initial' ? 'Initial Profile' : 'Weekly Check-in';
            
            container.innerHTML = `
                <div style="max-width: 800px; margin: 0 auto;">
                    <div style="text-align: center; margin-bottom: 30px; padding: 20px; background: #f0f7ff; border-radius: 12px; border: 2px solid #667eea;">
                        <h2 style="color: #667eea; margin: 0 0 10px 0;">${data.child_name}</h2>
                        <p style="color: #666; margin: 0;">
                            <strong>${entryTypeLabel}</strong> - ${lastCheckInDate}
                        </p>
                        ${data.summary ? `<p style="color: #333; margin: 15px 0 0 0; font-style: italic;">"${data.summary}"</p>` : ''}
                    </div>
                    
                    <div style="display: grid; gap: 20px;">
                        ${data.recommendations.map((rec, index) => `
                            <div style="background: white; border: 2px solid #e1e5e9; border-radius: 12px; padding: 20px;">
                                <h3 style="color: #667eea; margin: 0 0 15px 0;">${rec.trait || 'Unknown Trait'}</h3>
                                
                                <div style="margin-bottom: 15px;">
                                    <h4 style="color: #333; margin: 0 0 8px 0; font-size: 1em;">🎯 Goal:</h4>
                                    <p style="color: #555; margin: 0; line-height: 1.5;">${rec.goal || 'Support development'}</p>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <h4 style="color: #333; margin: 0 0 8px 0; font-size: 1em;">📝 Activity:</h4>
                                    <p style="color: #555; margin: 0; line-height: 1.6;">${rec.activity || 'No specific activity provided'}</p>
                                </div>
                                
                                ${rec.tldr ? `
                                    <div style="background: #f0f7ff; padding: 10px; border-radius: 8px; border-left: 4px solid #667eea;">
                                        <h4 style="color: #667eea; margin: 0 0 5px 0; font-size: 0.9em;">💡 Quick Summary:</h4>
                                        <p style="color: #333; margin: 0; font-weight: 500;">${rec.tldr}</p>
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <p style="color: #666; margin: 0 0 15px 0;">Want to see your complete recommendation history?</p>
                        <button class="btn" onclick="viewRecommendations('${data.child_id}')">View Full History</button>
                    </div>
                </div>
            `;
        }

        async function viewTraits(childId) {
            try {
                const traits = await apiCall(`/children/${childId}/traits`);
                displayTraits(traits, childId);
            } catch (error) {
                showError('uploadError', `Failed to load traits: ${error.message}`);
            }
        }

        function displayTraits(traits, childId) {
            const container = document.getElementById('traitsContainer');
            
            if (!traits || traits.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">No genetic traits found.</p>';
                showScreen('traitsScreen');
                return;
            }

            container.innerHTML = `
                <div class="traits-list">
                    ${traits.map(trait => `
                        <div class="trait-card" style="background: #f8f9fa; border: 1px solid #e1e5e9; border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                            <h3 style="color: #667eea; margin-bottom: 10px;">${trait.trait_name}</h3>
                            <p style="margin-bottom: 8px;"><strong>Gene:</strong> ${trait.gene}</p>
                            <p style="margin-bottom: 8px;"><strong>Confidence:</strong> <span style="color: #4CAF50; font-weight: bold;">${trait.confidence}</span></p>
                            <p style="margin-bottom: 0;"><strong>Description:</strong> ${trait.description}</p>
                        </div>
                    `).join('')}
                </div>
            `;
            
            showScreen('traitsScreen');
        }

        function displayRecommendationsHistory(history) {
            const container = document.getElementById('historyContainer');
            
            if (history.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">No recommendations history yet.</p>';
                return;
            }

            // Reverse the history array to show newest first
            const reversedHistory = [...history].reverse();
            
            container.innerHTML = reversedHistory.map((entry, index) => `
                <div class="recommendation-item" style="border: ${entry.entry_type === 'dr_bloom' ? '2px solid #667eea' : '1px solid #e0e0e0'}; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #667eea;">
                            ${entry.entry_type === 'dr_bloom' ? '🩺 Dr. Bloom Consultation' : 
                              entry.entry_type === 'initial' ? '🌟 Initial Assessment' :
                              `📋 Check-in #${reversedHistory.length - index - 1}`}
                        </h3>
                        <p class="timestamp">${new Date(entry.timestamp).toLocaleDateString()} - ${entry.entry_type}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #555; margin-bottom: 8px;">📝 Summary</h4>
                        <p style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin: 0;">${entry.summary}</p>
                    </div>
                    
                    ${entry.recommendations && entry.recommendations.length > 0 ? `
                        <div>
                            <h4 style="color: #555; margin-bottom: 10px;">💡 Recommendations (${entry.recommendations.length})</h4>
                            ${entry.recommendations.map(rec => `
                                <div style="background: #f0f4f8; padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                                    <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                        <span style="background: #667eea; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-right: 10px;">${rec.trait}</span>
                                        <strong style="color: #333;">${rec.goal}</strong>
                                    </div>
                                    <p style="margin: 5px 0 0 0; color: #555;">📌 ${rec.activity}</p>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p style="color: #666;">No specific recommendations generated.</p>'}
                </div>
            `).join('');
        }

        // Emergency Check-in
        function emergencyCheckIn(childId) {
            currentChildId = childId;
            document.getElementById('emergencyDescription').value = '';
            document.getElementById('emergencyImageStatus').textContent = 'Click to upload image (JPEG, PNG, or PDF)';
            selectedEmergencyImage = null;
            showScreen('emergencyScreen');
        }

        // Handle Dr. Bloom image selection
        let selectedDrBloomImage = null;
        function handleDrBloomImageSelect(event) {
            selectedDrBloomImage = event.target.files[0];
            if (selectedDrBloomImage) {
                document.getElementById('drBloomImageStatus').textContent = `Selected: ${selectedDrBloomImage.name}`;
            }
        }

        // Convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]); // Remove data:image/jpeg;base64, prefix
                reader.onerror = error => reject(error);
            });
        }

        // Submit Dr. Bloom session start
        async function submitDrBloomSession() {
            const description = document.getElementById('drBloomDescription').value.trim();
            
            if (!description) {
                showError('drBloomError', 'Please describe your concern');
                return;
            }

            try {
                document.getElementById('submitDrBloomBtn').disabled = true;
                document.getElementById('submitDrBloomBtn').textContent = 'Starting Session...';

                let imageBase64 = null;
                if (selectedDrBloomImage) {
                    imageBase64 = await fileToBase64(selectedDrBloomImage);
                }

                const response = await apiCall(`/children/${currentChildId}/dr-bloom/start`, {
                    method: 'POST',
                    body: JSON.stringify({
                        initial_concern: description,
                        image: imageBase64,
                        image_type: selectedDrBloomImage ? selectedDrBloomImage.type : null
                    })
                });

                // Display the Dr. Bloom session start results
                const container = document.getElementById('recommendationsContainer');
                container.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #4CAF50;">Dr. Bloom Session Started</h3>
                        <p>${response.initial_response || 'Dr. Bloom session started successfully.'}</p>
                        <p><strong>Session ID:</strong> ${response.session_id}</p>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0;">
                        <p><strong>Initial Concern:</strong> ${description}</p>
                        ${selectedDrBloomImage ? `<p><strong>Image:</strong> ${selectedDrBloomImage.name} attached</p>` : ''}
                    </div>
                `;
                showScreen('resultsScreen');
            } catch (error) {
                showError('drBloomError', `Failed to start Dr. Bloom session: ${error.message}`);
            } finally {
                document.getElementById('submitDrBloomBtn').disabled = false;
                document.getElementById('submitDrBloomBtn').textContent = 'Start Dr. Bloom Session';
            }
        }

        // Dr. Bloom Chat Variables
        let currentDrBloomSessionId = null;
        let selectedChatImage = null;

        async function openDrBloomConsultation(childId) {
            currentChildId = childId;
            selectedDrBloomImage = null;
            selectedChatImage = null;
            
            // Show screen first, then load content
            showScreen('drBloomScreen');
            document.getElementById('drBloomChat').style.display = 'block';
            
            try {
                // Clear chat and show loading
                document.getElementById('chatMessages').innerHTML = '<div class="typing-indicator"><div>Starting Dr. Bloom session...</div></div>';
                
                // Start session immediately with a default greeting
                const response = await apiCall(`/children/${childId}/dr-bloom/start`, {
                    method: 'POST',
                    body: JSON.stringify({
                        initial_concern: "I'd like to consult with Dr. Bloom about my child.",
                        image: null,
                        image_type: null
                    })
                });

                // Store session ID and clear loading
                currentDrBloomSessionId = response.session_id;
                console.log('Dr. Bloom session started with ID:', currentDrBloomSessionId);
                console.log('Full response:', response);
                
                document.getElementById('chatMessages').innerHTML = '';
                
                // Add Dr. Bloom's welcome message
                addChatMessage('dr-bloom', response.initial_response || "Hello! I'm Dr. Bloom, your AI pediatric consultant. What would you like to discuss about your child today?");
                
                // Focus on chat input
                document.getElementById('chatInput').focus();
                
            } catch (error) {
                document.getElementById('chatMessages').innerHTML = `<div style="color: red; padding: 15px;">Failed to start Dr. Bloom session: ${error.message}</div>`;
            }
        }

        // Handle chat image selection
        function handleChatImageSelect(event) {
            selectedChatImage = event.target.files[0];
            if (selectedChatImage) {
                document.getElementById('chatImagePreview').textContent = `Image selected: ${selectedChatImage.name}`;
            } else {
                document.getElementById('chatImagePreview').textContent = '';
            }
        }

        // Start Dr. Bloom chat session
        async function startDrBloomChat() {
            const description = document.getElementById('drBloomDescription').value.trim();
            
            if (!description) {
                showError('drBloomSetupError', 'Please describe your concern');
                return;
            }

            try {
                document.getElementById('startDrBloomBtn').disabled = true;
                document.getElementById('startDrBloomBtn').textContent = 'Starting...';

                let imageBase64 = null;
                if (selectedDrBloomImage) {
                    imageBase64 = await fileToBase64(selectedDrBloomImage);
                }

                const response = await apiCall(`/children/${currentChildId}/dr-bloom/start`, {
                    method: 'POST',
                    body: JSON.stringify({
                        initial_concern: description,
                        image: imageBase64,
                        image_type: selectedDrBloomImage ? selectedDrBloomImage.type : null
                    })
                });

                // Store session ID and switch to chat interface
                currentDrBloomSessionId = response.session_id;
                
                // Initialize chat
                document.getElementById('chatMessages').innerHTML = '';
                
                // Add initial user message
                addChatMessage('user', description, selectedDrBloomImage ? selectedDrBloomImage.name : null);
                
                // Add Dr. Bloom's initial response
                addChatMessage('dr-bloom', response.initial_response || 'Hello! I\'m Dr. Bloom. I\'ve reviewed your concern and I\'m here to help.');
                
                // Switch to chat interface
                document.getElementById('drBloomSetup').style.display = 'none';
                document.getElementById('drBloomChat').style.display = 'block';
                
                // Focus on chat input
                document.getElementById('chatInput').focus();
                
            } catch (error) {
                showError('drBloomSetupError', `Failed to start Dr. Bloom session: ${error.message}`);
            } finally {
                document.getElementById('startDrBloomBtn').disabled = false;
                document.getElementById('startDrBloomBtn').textContent = 'Start Consultation';
            }
        }

        // Add message to chat
        function addChatMessage(sender, message, imageAttachment = null) {
            const chatMessages = document.getElementById('chatMessages');
            const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            
            if (sender === 'dr-bloom') {
                messageDiv.innerHTML = `
                    <div class="sender">Dr. Bloom</div>
                    <div>${message}</div>
                    <div class="timestamp">${timestamp}</div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div>${message}</div>
                    ${imageAttachment ? `<div class="image-attachment">📷 ${imageAttachment}</div>` : ''}
                    <div class="timestamp">${timestamp}</div>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Show typing indicator
        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="sender" style="font-weight: bold; color: #4CAF50; font-size: 14px; margin-bottom: 5px;">Dr. Bloom</div>
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Hide typing indicator
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Send chat message
        async function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (!message) return;
            
            if (!currentDrBloomSessionId) {
                showError('drBloomChatError', 'No active Dr. Bloom session. Please start a new consultation.');
                return;
            }
            
            console.log('Sending message to session:', currentDrBloomSessionId);
            
            try {
                // Disable send button
                document.getElementById('sendBtn').disabled = true;
                
                // Add user message to chat
                addChatMessage('user', message, selectedChatImage ? selectedChatImage.name : null);
                
                // Clear input
                chatInput.value = '';
                document.getElementById('chatImagePreview').textContent = '';
                
                // Show typing indicator
                showTypingIndicator();
                
                // Prepare image if selected
                let imageBase64 = null;
                if (selectedChatImage) {
                    imageBase64 = await fileToBase64(selectedChatImage);
                }
                
                // Send message to API
                const response = await apiCall(`/chatbot/conversations/${currentDrBloomSessionId}/messages`, {
                    method: 'POST',
                    body: JSON.stringify({
                        message: message,
                        agent_type: 'dr_bloom',
                        image: imageBase64,
                        image_type: selectedChatImage ? selectedChatImage.type : null
                    })
                });
                
                // Hide typing indicator
                hideTypingIndicator();
                
                // Add Dr. Bloom's response
                addChatMessage('dr-bloom', response.agent_response);
                
                // Clear selected image
                selectedChatImage = null;
                document.getElementById('chatImageFile').value = '';
                
            } catch (error) {
                hideTypingIndicator();
                showError('drBloomChatError', `Failed to send message: ${error.message}`);
            } finally {
                document.getElementById('sendBtn').disabled = false;
            }
        }

        // Complete Dr. Bloom session
        async function completeDrBloomSession() {
            if (!currentDrBloomSessionId) {
                showError('drBloomChatError', 'No active session to complete');
                return;
            }
            
            try {
                document.getElementById('completeBtn').disabled = true;
                document.getElementById('completeBtn').textContent = 'Completing...';
                
                const response = await apiCall(`/children/${currentChildId}/dr-bloom/complete`, {
                    method: 'POST',
                    body: JSON.stringify({
                        session_id: currentDrBloomSessionId,
                        child_id: currentChildId
                    })
                });
                
                // Show medical consultation completion message
                const container = document.getElementById('recommendationsContainer');
                
                if (response.medical_log) {
                    // Display the actual medical log content
                    const log = response.medical_log;
                    container.innerHTML = `
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #4CAF50;">✅ Dr. Bloom Consultation Completed</h3>
                            <p>Here's what we discussed and some immediate steps you can take:</p>
                        </div>
                        
                        <div class="recommendation-item" style="border: 2px solid #ff6b6b; padding: 20px; border-radius: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0; color: #ff6b6b;">📋 Consultation Summary</h3>
                                <p class="timestamp">${new Date().toLocaleDateString()}</p>
                            </div>
                            
                            ${log.emergency_warning ? `
                                <div style="background: #ffebee; padding: 15px; border-radius: 8px; border: 2px solid #f44336; margin-bottom: 20px;">
                                    <h4 style="color: #f44336; margin: 0;">⚠️ ${log.emergency_warning}</h4>
                                </div>
                            ` : ''}
                            
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #555; margin-bottom: 8px;">🩺 Problem Discussed</h4>
                                <p style="background: #fff5f5; padding: 15px; border-radius: 8px; margin: 0; font-size: 16px; font-weight: 500;">
                                    ${log?.problem_discussed || 'No problem discussed'}
                                </p>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #555; margin-bottom: 8px;">✅ What You Can Do Right Now</h4>
                                <ul style="margin: 0; padding-left: 25px;">
                                    ${(log?.immediate_recommendations || []).map(rec => 
                                        `<li style="margin-bottom: 8px; line-height: 1.5;">${rec || 'No recommendation available'}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                            
                            ${log?.follow_up_questions && log.follow_up_questions.length > 0 ? `
                                <div style="margin-bottom: 20px;">
                                    <h4 style="color: #555; margin-bottom: 8px;">❓ Questions to Ask Your Doctor</h4>
                                    <ol style="margin: 0; padding-left: 25px;">
                                        ${log.follow_up_questions.map(q => 
                                            `<li style="margin-bottom: 8px; line-height: 1.5;">${q || 'No question specified'}</li>`
                                        ).join('')}
                                    </ol>
                                </div>
                            ` : ''}
                            
                            ${log?.immunity_traits_mentioned && log.immunity_traits_mentioned.length > 0 ? `
                                <div style="margin-bottom: 20px;">
                                    <h4 style="color: #555; margin-bottom: 8px;">🧬 Related Genetic Traits</h4>
                                    <p style="background: #e8f5e9; padding: 10px; border-radius: 8px; margin: 0;">
                                        ${log.immunity_traits_mentioned.join(', ')}
                                    </p>
                                </div>
                            ` : ''}
                            
                            <div style="background: #f0f4f8; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                                <p style="margin: 0; font-size: 14px; color: #555; font-style: italic;">
                                    <strong>Important:</strong> ${log?.disclaimer || 'Please consult with your healthcare provider for medical advice.'}
                                </p>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; background: #f0f8ff; padding: 15px; border-radius: 8px;">
                            <h4 style="color: #1976d2; margin: 0 0 10px 0;">💡 What's Next?</h4>
                            <ul style="margin: 0; padding-left: 20px;">
                                <li>Try the immediate recommendations above</li>
                                <li>Monitor your child's symptoms over the next 24-48 hours</li>
                                <li>If symptoms persist or worsen, consult your healthcare provider</li>
                                <li>You can review this consultation in the Immunity & Resilience dashboard</li>
                            </ul>
                        </div>
                    `;
                } else {
                    // No medical log was created
                    container.innerHTML = `
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #4CAF50;">✅ Dr. Bloom Consultation Completed</h3>
                            <p>${response.summary}</p>
                        </div>
                        
                        <div class="recommendation-item" style="border: 2px solid #ff9800; padding: 20px; border-radius: 12px;">
                            <div style="margin-bottom: 15px;">
                                <h3 style="margin: 0; color: #ff9800;">📋 No Medical Log Created</h3>
                            </div>
                            
                            <p style="margin-bottom: 15px;">No medical topics were detected in this conversation.</p>
                            
                            <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                                <h4 style="color: #ff9800; margin: 0 0 10px 0;">💡 Tips for Medical Consultations</h4>
                                <ul style="margin: 0; padding-left: 20px; color: #666;">
                                    <li>Dr. Bloom is designed for medical consultations</li>
                                    <li>Discuss symptoms, health concerns, or medical questions</li>
                                    <li>For general behavioral advice, use the Weekly Check-in feature</li>
                                </ul>
                            </div>
                        </div>
                    `;
                }
                
                // Reset session
                currentDrBloomSessionId = null;
                showScreen('resultsScreen');
                
            } catch (error) {
                showError('drBloomChatError', `Failed to complete session: ${error.message}`);
            } finally {
                document.getElementById('completeBtn').disabled = false;
                document.getElementById('completeBtn').textContent = 'Complete Consultation';
            }
        }


        // Immunity dashboard functions
        async function viewImmunityDashboard(childId) {
            console.log('🛡️ IMMUNITY BUTTON CLICKED:', childId);
            currentChildId = childId;
            
            try {
                console.log('📱 SHOWING IMMUNITY SCREEN');
                // Show loading state
                document.getElementById('immunityContent').innerHTML = '<div style="text-align: center; padding: 40px;"><p>Loading immunity dashboard...</p></div>';
                showScreen('immunityScreen');
                
                console.log('📡 FETCHING IMMUNITY DASHBOARD DATA');
                // Fetch dashboard data
                const dashboardData = await apiCall(`/immunity/${childId}/dashboard`);
                
                console.log('✅ IMMUNITY DATA RECEIVED:', dashboardData);
                displayImmunityDashboard(dashboardData);
                
            } catch (error) {
                console.log('❌ IMMUNITY DASHBOARD ERROR:', error);
                document.getElementById('immunityContent').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h3 style="color: #f44336;">Failed to load immunity dashboard</h3>
                        <p style="color: #666;">${error.message}</p>
                        <button class="btn" onclick="showDashboard()">Back to Dashboard</button>
                    </div>
                `;
            }
        }

        function displayImmunityDashboard(dashboardData) {
            console.log('🛡️ Dashboard data:', dashboardData);
            console.log('🔍 Raw suggestions object:', dashboardData?.suggestions);
            console.log('🔍 Raw medical_logs object:', dashboardData?.medical_logs);
            
            const suggestions = dashboardData?.suggestions || {};
            const medical_logs = dashboardData?.medical_logs || {};
            
            console.log('📊 Processed suggestions:', suggestions);
            console.log('📊 Processed medical_logs:', medical_logs);
            
            const child_name = suggestions?.child_name || 'Child';
            const suggestions_by_trait = suggestions?.suggestions_by_trait || {};
            const immunity_traits = suggestions?.immunity_traits || [];
            
            console.log('👶 Child name:', child_name);
            console.log('🧬 Immunity traits:', immunity_traits);
            console.log('💡 Suggestions by trait:', suggestions_by_trait);
            
            let content = `
                <div style="margin-bottom: 20px;">
                    <h2>🛡️ Immunity & Resilience Dashboard</h2>
                    <h3>${child_name}</h3>
                    <p style="color: #666;">Based on ${immunity_traits.length} genetic trait${immunity_traits.length !== 1 ? 's' : ''}</p>
                </div>
            `;
            
            // Display suggestions by trait
            if (suggestions_by_trait && Object.keys(suggestions_by_trait).length > 0) {
                content += `
                    <div class="immunity-section">
                        <h3>📋 Personalized Suggestions</h3>
                `;
                
                for (const [traitName, suggestions] of Object.entries(suggestions_by_trait)) {
                    console.log(`🧬 Processing trait: ${traitName}`, suggestions);
                    content += `
                        <div class="trait-suggestions">
                            <h4 style="color: #667eea; margin-bottom: 15px;">${traitName}</h4>
                    `;
                    
                    suggestions.forEach((suggestion, index) => {
                        console.log(`💡 Suggestion ${index} for ${traitName}:`, suggestion);
                        console.log(`🔍 All suggestion keys:`, Object.keys(suggestion || {}));
                        
                        // Try different possible field names
                        const suggestion_type = suggestion?.suggestion_type || suggestion?.type || suggestion?.category || 'Unknown';
                        const suggestion_text = suggestion?.suggestion || suggestion?.text || suggestion?.recommendation || 'No suggestion available';
                        const rationale = suggestion?.rationale || suggestion?.reason || suggestion?.explanation || 'No rationale provided';
                        
                        console.log(`   - Type: "${suggestion_type}" (from field: ${suggestion?.suggestion_type ? 'suggestion_type' : suggestion?.type ? 'type' : suggestion?.category ? 'category' : 'none found'})`);
                        console.log(`   - Text: "${suggestion_text}"`);
                        console.log(`   - Rationale: "${rationale}"`);
                        
                        const icon = suggestion_type === 'Provide' ? '✅' : '❌';
                        const iconClass = suggestion_type === 'Provide' ? 'provide' : 'avoid';
                        
                        content += `
                            <div class="suggestion-item ${iconClass}">
                                <div class="suggestion-header">
                                    <span class="suggestion-icon">${icon}</span>
                                    <span class="suggestion-type">${suggestion_type}</span>
                                    <span class="suggestion-text">${suggestion_text}</span>
                                </div>
                                <div class="suggestion-rationale">
                                    <strong>Rationale:</strong> ${rationale}
                                </div>
                            </div>
                        `;
                    });
                    
                    content += '</div>';
                }
                
                content += '</div>';
            } else {
                content += `
                    <div class="immunity-section">
                        <h3>📋 Personalized Suggestions</h3>
                        <p style="color: #666; text-align: center; padding: 20px;">No immunity & resilience traits found for this child.</p>
                    </div>
                `;
            }
            
            // Display medical logs
            content += `
                <div class="immunity-section">
                    <h3>🏥 Medical Visit Logs</h3>
            `;
            
            const logs = medical_logs?.logs || [];
            console.log('📋 Medical logs array:', logs);
            console.log('📋 Number of logs:', logs.length);
            console.log('⚠️ Has emergency indicators:', medical_logs?.has_emergency_indicators);
            
            if (logs.length > 0) {
                if (medical_logs?.has_emergency_indicators) {
                    content += '<div style="background: #ffebee; border: 1px solid #f44336; border-radius: 8px; padding: 15px; margin-bottom: 20px;"><strong style="color: #f44336;">⚠️ Emergency indicators found in recent logs. Please consult your doctor.</strong></div>';
                }
                
                logs.forEach((log, logIndex) => {
                    console.log(`📋 Processing log ${logIndex}:`, log);
                    const logDate = log?.date ? new Date(log.date).toLocaleDateString() : 'Unknown date';
                    const conversationDate = log?.conversation_date ? new Date(log.conversation_date).toLocaleDateString() : logDate;
                    
                    console.log(`   📅 Log date: "${logDate}"`);
                    console.log(`   📅 Conversation date: "${conversationDate}"`);
                    console.log(`   🩺 Problem discussed: "${log?.problem_discussed}"`);
                    console.log(`   ✅ Immediate recommendations:`, log?.immediate_recommendations);
                    console.log(`   ❓ Follow up questions:`, log?.follow_up_questions);
                    console.log(`   🧬 Immunity traits mentioned:`, log?.immunity_traits_mentioned);
                    console.log(`   ⚠️ Emergency warning: "${log?.emergency_warning}"`);
                    console.log(`   📝 Disclaimer: "${log?.disclaimer}"`);
                    
                    content += `
                        <div class="medical-log-item">
                            <div class="log-header">
                                <h4>Medical Log - ${conversationDate}</h4>
                                <small style="color: #666;">Generated: ${logDate}</small>
                            </div>
                            
                            ${(log?.primary_concerns && log.primary_concerns.length > 0) ? `
                                <div class="log-section">
                                    <strong>Primary Concerns:</strong>
                                    <ul>
                                        ${log.primary_concerns.map(concern => `<li>${concern || 'No concern specified'}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            <div class="log-section">
                                <strong>Summary:</strong>
                                <p>${log?.summary || 'No summary available'}</p>
                            </div>
                            
                            ${(log?.traits_discussed && log.traits_discussed.length > 0) ? `
                                <div class="log-section">
                                    <strong>Immunity Traits Discussed:</strong>
                                    <div class="traits-tags">
                                        ${log.traits_discussed.map(trait => `<span class="trait-tag">${trait || 'Unknown trait'}</span>`).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${(log?.questions_for_doctor && log.questions_for_doctor.length > 0) ? `
                                <div class="log-section">
                                    <strong>Questions for Doctor:</strong>
                                    <ul>
                                        ${log.questions_for_doctor.map(question => `<li>${question || 'No question specified'}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            ${(log?.emergency_indicators && log.emergency_indicators.length > 0) ? `
                                <div class="log-section emergency">
                                    <strong style="color: #f44336;">⚠️ Emergency Indicators:</strong>
                                    <ul>
                                        ${log.emergency_indicators.map(indicator => `<li style="color: #f44336;">${indicator || 'No indicator specified'}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            } else {
                content += '<p style="color: #666; text-align: center; padding: 20px;">No medical logs yet. Logs are created when Dr. Bloom discussions involve immunity-related topics.</p>';
            }
            
            content += '</div>';
            
            
            console.log('🎨 Final rendered HTML content:', content);
            document.getElementById('immunityContent').innerHTML = content;
        }

        // Growth Milestones functions
        let currentGrowthTab = 'overview';
        
        async function viewGrowthMilestones(childId) {
            console.log('📈 GROWTH MILESTONES BUTTON CLICKED:', childId);
            currentChildId = childId;
            
            try {
                console.log('📱 SHOWING GROWTH MILESTONES SCREEN');
                // Show loading state
                document.getElementById('growthContent').innerHTML = '<div style="text-align: center; padding: 40px;"><p>Loading growth roadmap...</p></div>';
                showScreen('growthMilestonesScreen');
                
                // Load roadmap directly
                const response = await apiCall(`/growth-milestones/${childId}/roadmap`);
                console.log('✅ GROWTH ROADMAP RECEIVED:', response);
                
                document.getElementById('growthContent').innerHTML = displayFullRoadmap(response.data);
                
            } catch (error) {
                console.log('❌ GROWTH MILESTONES ERROR:', error);
                document.getElementById('growthContent').innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #f44336;">Failed to load growth milestones</h3>
                        <p>${error.message}</p>
                        <button class="btn" onclick="showDashboard()">Back to Dashboard</button>
                    </div>
                `;
            }
        }
        
        
        function displayFullRoadmap(data) {
            const { child_name, current_age, roadmap } = data;
            
            if (!roadmap || roadmap.length === 0) {
                return `
                    <div style="text-align: center; padding: 40px;">
                        <h3>No Growth Roadmap Available</h3>
                        <p style="color: #666;">No Growth & Development genetic traits found for this child.</p>
                    </div>
                `;
            }
            
            let content = `
                <div style="max-width: 900px; margin: 0 auto;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h2>🗺️ ${child_name}'s Complete Growth Roadmap</h2>
                        <p style="color: #666;">Journey through all age-based recommendations</p>
                    </div>
                    
                    <div style="position: relative;">
            `;
            
            roadmap.forEach((ageGroup, index) => {
                const isLast = index === roadmap.length - 1;
                let statusColor, statusIcon, statusText;
                
                if (ageGroup.is_past) {
                    statusColor = '#2196f3';
                    statusIcon = '✅';
                    statusText = 'Completed';
                } else if (ageGroup.is_current) {
                    statusColor = '#4caf50';
                    statusIcon = '🎯';
                    statusText = 'Current Focus';
                } else {
                    statusColor = '#ff9800';
                    statusIcon = '⏳';
                    statusText = 'Upcoming';
                }
                
                content += `
                    <div style="position: relative; margin-bottom: ${isLast ? '0' : '40px'};">
                        <!-- Timeline line -->
                        ${!isLast ? `<div style="position: absolute; left: 20px; top: 60px; width: 2px; height: 100%; background: #e0e0e0; z-index: 1;"></div>` : ''}
                        
                        <!-- Timeline dot -->
                        <div style="position: absolute; left: 12px; top: 20px; width: 16px; height: 16px; background: ${statusColor}; border-radius: 50%; z-index: 2;"></div>
                        
                        <!-- Content card -->
                        <div style="margin-left: 50px; background: white; border: 2px solid ${statusColor}; border-radius: 12px; padding: 20px; ${ageGroup.is_current ? 'box-shadow: 0 4px 16px rgba(76, 175, 80, 0.3);' : ''}">
                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <h3 style="color: ${statusColor}; margin: 0;">Ages ${ageGroup.age_start}-${ageGroup.age_end} ${statusIcon}</h3>
                                    <p style="color: #666; font-size: 14px; margin: 5px 0 0 0;">${statusText}</p>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <p style="color: #333; font-weight: 500;">${ageGroup.milestones.length} recommendation${ageGroup.milestones.length !== 1 ? 's' : ''} for this age group</p>
                            </div>
                            
                            <div style="display: grid; gap: 15px;">
                `;
                
                ageGroup.milestones.forEach(milestone => {
                    const iconMap = {
                        'brain_icon': '🧠', 'tummy_icon': '🤱', 'energy_icon': '⚡', 'shield_icon': '🛡️',
                        'health_icon': '💪', 'idea_icon': '💡', 'school_icon': '🎒', 'choices_icon': '🤔',
                        'balance_icon': '⚖️', 'battery_icon': '🔋'
                    };
                    const icon = iconMap[milestone.graphic_icon_id] || '📈';
                    
                    content += `
                        <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; border-left: 4px solid ${statusColor};">
                            <div style="display: flex; align-items: start; gap: 10px;">
                                <span style="font-size: 20px;">${icon}</span>
                                <div style="flex: 1;">
                                    <h4 style="color: #333; margin: 0 0 5px 0;">${milestone.trait_name} (${milestone.gene_id})</h4>
                                    <p style="color: #666; font-size: 14px; line-height: 1.5; margin: 0 0 10px 0;">${milestone.focus_description}</p>
                                    
                                    ${milestone.food_examples && milestone.food_examples.length > 0 ? `
                                        <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                                            ${milestone.food_examples.slice(0, 4).map(food => 
                                                `<span style="background: ${statusColor}; color: white; padding: 2px 6px; border-radius: 12px; font-size: 11px;">${food.replace(/_/g, ' ')}</span>`
                                            ).join('')}
                                            ${milestone.food_examples.length > 4 ? `<span style="color: #666; font-size: 11px;">+${milestone.food_examples.length - 4} more</span>` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                content += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            content += `
                    </div>
                </div>
            `;
            
            return content;
        }

        // Allow Enter key to send message
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendChatMessage();
                    }
                });
            }
        });

        // Initialize app
        if (authToken) {
            loadDashboard();
        } else {
            showLogin();
        }
    </script>
</body>
</html>